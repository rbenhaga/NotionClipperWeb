# ==============================================
# BACKEND CONFIGURATION
# ==============================================
# Note: OAuth secrets et Stripe sont chargÃ©s depuis Supabase Vault
# Ces variables sont uniquement pour le fallback en dev

# Server
NODE_ENV=development
PORT=3001
HOST=localhost

# Allowed Origins (CORS)
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173

# ==============================================
# SUPABASE (REQUIS)
# ==============================================
SUPABASE_URL=https://rijjtngbgahxdjflfyhi.supabase.co
SUPABASE_ANON_KEY=your_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here

# ==============================================
# JWT (REQUIS)
# ==============================================
JWT_SECRET=your_jwt_secret_here
JWT_EXPIRES_IN=7d

# ==============================================
# RATE LIMITING
# ==============================================
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# ==============================================
# LOGGING
# ==============================================
LOG_LEVEL=debug
LOG_FILE=./logs/backend.log

# ==============================================
# FRONTEND URL
# ==============================================
FRONTEND_URL=http://localhost:5173

# ==============================================
# EDGE FUNCTION AUTHENTICATION (REQUIS EN PROD)
# ==============================================
# ðŸ”’ SECURITY: Shared secret for backend-to-edge communication
# Generate with: openssl rand -hex 32
# Must match BACKEND_SHARED_SECRET in Supabase Edge Function secrets
BACKEND_SHARED_SECRET=

# ==============================================
# CONTENT INSIGHTS (Optionnel)
# ==============================================
# Set to 'true' to allow graceful degradation if content_insights table is missing
# In production, leave unset to get 503 errors if table is missing (alerts ops)
# CONTENT_INSIGHTS_OPTIONAL=true

# ==============================================
# FALLBACK SECRETS (Optionnel - ChargÃ©s depuis Vault)
# ==============================================
# Ces variables sont utilisÃ©es uniquement si Supabase Vault Ã©choue
# En production, configurez-les dans Supabase Vault

# GOOGLE_CLIENT_ID=
# GOOGLE_CLIENT_SECRET=
# GOOGLE_REDIRECT_URI=http://localhost:3001/api/auth/google/callback

# NOTION_CLIENT_ID=
# NOTION_CLIENT_SECRET=
# NOTION_REDIRECT_URI=http://localhost:3001/api/auth/notion/callback

# STRIPE_SECRET_KEY=
# STRIPE_WEBHOOK_SECRET=
# STRIPE_PRICE_MONTHLY=
# STRIPE_PRICE_ANNUAL=

# TOKEN_ENCRYPTION_KEY=

# ==============================================
# P0 NOTION RELIABILITY (Nouveau - 2025-12-20)
# ==============================================

# --- Observability ---
# Enable /metrics endpoint (JSON format)
ENABLE_PROM_METRICS=true
# Route for metrics (default: /metrics)
METRICS_ROUTE=/metrics
# ðŸ”’ SECURITY: Token to protect /metrics endpoint (REQUIRED in prod)
# Generate with: openssl rand -hex 32
METRICS_TOKEN=

# --- Feature Flags ---
# Enable degraded mode (blocks READ routes, writes still queue as 202)
NOTION_DEGRADED_MODE=false
# Enable async writes (202 + jobId instead of sync response)
# Set to 'false' for safe rollout, then 'true' when app is ready
PROXY_WRITES_ASYNC=false

# --- Notion Client Tuning ---
# Max concurrent in-flight requests to Notion (backpressure)
NOTION_MAX_INFLIGHT=50
# Cooldown threshold: if Retry-After > this, fast-fail instead of sleep
NOTION_COOLDOWN_MIN_SECONDS=5
# Max Retry-After we'll ever respect (beyond this = cooldown + fail)
NOTION_MAX_RETRY_AFTER_SECONDS=300
# Max retries for READ operations (writes = 0, handled by queue)
NOTION_READ_MAX_RETRIES=2
# Backoff base/max for retries
NOTION_BACKOFF_BASE_MS=500
NOTION_BACKOFF_MAX_MS=10000

# --- Circuit Breaker ---
# Number of consecutive failures before circuit opens
NOTION_BREAKER_THRESHOLD=5
# Time before circuit attempts half-open (ms)
NOTION_BREAKER_RESET_MS=60000
# Max calls allowed in half-open state
NOTION_BREAKER_HALF_OPEN_CALLS=1

# --- Write Queue ---
# Max attempts before job is marked failed
NOTION_WRITE_MAX_ATTEMPTS=8
# Backoff for queue retries
NOTION_WRITE_BACKOFF_MS=2000
NOTION_WRITE_BACKOFF_MAX_MS=30000
# Concurrent jobs processed per worker tick
NOTION_WRITE_CONCURRENCY=3
